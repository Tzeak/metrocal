<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Metrograph Movie Calendar</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      .floating-container {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 9999;
        padding: 1rem;
        display: none;
      }
      .floating-container.visible {
        display: block;
      }
      .content-container {
        padding-bottom: 5rem;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 content-container">
      <h1 class="text-4xl font-bold text-center mb-8">
        Metrograph Movie Calendar
      </h1>

      <div id="loading" class="text-center py-8">
        <div
          class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"
        ></div>
        <p class="mt-4 text-gray-600">Loading movies...</p>
      </div>

      <div
        id="error"
        class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"
        role="alert"
      >
        <span class="block sm:inline" id="error-message"></span>
      </div>

      <div id="movie-list" class="hidden">
        <div class="bg-white rounded-lg shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6">Select Movies</h2>
          <div id="movies-container" class="space-y-4">
            <!-- Movies will be inserted here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Floating container for button and success message -->
    <div id="floating-container" class="floating-container">
      <div class="container mx-auto px-4 flex items-center justify-between">
        <div
          id="success"
          class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative flex-1 mr-4"
          role="alert"
        >
          <span class="block sm:inline"
            >Calendar created successfully! Check your downloads folder.</span
          >
        </div>
        <button
          id="submit-button"
          class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed whitespace-nowrap"
        >
          Create Calendar
        </button>
      </div>
    </div>

    <script>
      let movies = [];
      const selectedMovies = new Set();

      async function loadMovies() {
        try {
          const response = await fetch("/api/movies");
          if (!response.ok) {
            throw new Error("Failed to load movies");
          }
          movies = await response.json();
          displayMovies();
        } catch (error) {
          showError(error.message);
        } finally {
          document.getElementById("loading").classList.add("hidden");
        }
      }

      function displayMovies() {
        const container = document.getElementById("movies-container");
        container.innerHTML = "";

        // Sort movies by earliest showtime
        const sortedMovies = [...movies].sort((a, b) => {
          const aEarliest = Math.min(
            ...a.showtimes.map((st) => new Date(st.datetime))
          );
          const bEarliest = Math.min(
            ...b.showtimes.map((st) => new Date(st.datetime))
          );
          return aEarliest - bEarliest;
        });

        sortedMovies.forEach((movie) => {
          const movieItem = document.createElement("div");
          movieItem.className = "mb-4 bg-gray-50 rounded-lg p-4";

          const movieHeader = document.createElement("div");
          movieHeader.className = "flex items-center space-x-4 mb-2";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.className = "h-5 w-5 text-blue-600 rounded";
          checkbox.value = movie.id;
          checkbox.checked = selectedMovies.has(movie.id);
          checkbox.addEventListener("change", (e) => {
            if (e.target.checked) {
              selectedMovies.add(movie.id);
            } else {
              selectedMovies.delete(movie.id);
            }
            updateSubmitButton();
          });

          const title = document.createElement("div");
          title.className = "text-lg font-medium text-gray-900";
          title.textContent = movie.title;

          movieHeader.appendChild(checkbox);
          movieHeader.appendChild(title);

          const showtimesContainer = document.createElement("div");
          showtimesContainer.className = "ml-9 space-y-1";

          // Sort showtimes by datetime
          const sortedShowtimes = [...movie.showtimes].sort(
            (a, b) => new Date(a.datetime) - new Date(b.datetime)
          );

          sortedShowtimes.forEach((showtime) => {
            const showtimeItem = document.createElement("div");
            showtimeItem.className = "text-sm text-gray-600";
            if (showtime.sold_out) {
              showtimeItem.className += " line-through text-gray-400";
            }

            if (showtime.url) {
              const link = document.createElement("a");
              link.href = showtime.url;
              link.target = "_blank";
              link.className =
                showtimeItem.className + " hover:text-blue-600 hover:underline";
              link.textContent = `${showtime.formatted_time} (${
                showtime.formatted_date
              })${showtime.sold_out ? " - Sold Out" : ""}`;
              showtimeItem.appendChild(link);
            } else {
              showtimeItem.textContent = `${showtime.formatted_time} (${
                showtime.formatted_date
              })${showtime.sold_out ? " - Sold Out" : ""}`;
            }

            showtimesContainer.appendChild(showtimeItem);
          });

          movieItem.appendChild(movieHeader);
          movieItem.appendChild(showtimesContainer);
          container.appendChild(movieItem);
        });

        document.getElementById("movie-list").classList.remove("hidden");
        updateSubmitButton();
      }

      function updateSubmitButton() {
        const submitButton = document.getElementById("submit-button");
        const floatingContainer = document.getElementById("floating-container");
        submitButton.disabled = selectedMovies.size === 0;

        // Show/hide floating container based on selection
        if (selectedMovies.size > 0) {
          floatingContainer.classList.add("visible");
        } else {
          floatingContainer.classList.remove("visible");
        }
      }

      function showError(message) {
        const errorDiv = document.getElementById("error");
        const errorMessage = document.getElementById("error-message");
        errorMessage.textContent = message;
        errorDiv.classList.remove("hidden");
      }

      async function createCalendar() {
        const submitButton = document.getElementById("submit-button");
        submitButton.disabled = true;

        try {
          const selectedMovieData = movies.filter((movie) =>
            selectedMovies.has(movie.id)
          );
          const response = await fetch("/api/create-calendar", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ selectedMovies: selectedMovieData }),
          });

          if (!response.ok) {
            throw new Error("Failed to create calendar");
          }

          // Get the blob from the response
          const blob = await response.blob();

          // Create a download link
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download =
            response.headers
              .get("content-disposition")
              ?.split("filename=")[1] || "metrograph_events.ics";
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          document.getElementById("success").classList.remove("hidden");
          selectedMovies.clear();
          displayMovies();
        } catch (error) {
          showError(error.message);
        } finally {
          submitButton.disabled = false;
        }
      }

      document
        .getElementById("submit-button")
        .addEventListener("click", createCalendar);

      // Load movies when the page loads
      loadMovies();
    </script>
  </body>
</html>
